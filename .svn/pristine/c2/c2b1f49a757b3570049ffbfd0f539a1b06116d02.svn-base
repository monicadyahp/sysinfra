<?= $this->extend("main/template") ?>
<?= $this->section("content") ?>

<style>
    /* Styling for machine buttons */
    #machine-container {
        margin-top: 10px;
    }

    .btn-machine {
        margin: 5px;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .navPillsBordered {
        border-bottom: 1px solid #CBD5E1;
        padding-bottom: 10px;
        gap: 20px;
    }
    .navPillsBordered .nav-item {
        border-radius: 7px;
        border: 1px solid #2563EB;
    }
    .navPillsBordered .nav-item a {
        color: #2563EB;
    }

    .highlighted-row {
        background-color: #EFF6FF !important;
    }

    .nav-link:hover,
    .nav-link:focus {
        color: #1E3A8A !important;
    }
    .nav-link.active:hover,
    .nav-link.active:focus {
        color: #BFDBFE !important;
    }
    #grid-excel {
        visibility: hidden !important;
        position: absolute !important;
        
    }

</style>

<div class="card">
    <div class="card-body">
        <!-- Navbar pills -->
        <div class="row">
            <div class="col-md-12">
                <ul class="nav nav-pills flex-column flex-sm-row mb-2 navPillsBordered" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="row-data-tab" data-bs-toggle="tab" href="#row-data" role="tab" aria-controls="row-data" aria-selected="true">
                            <i class="ti-sm ti ti-layout-grid me-1"></i> Raw Data
                        </a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="prod-limit-tab" data-bs-toggle="tab" href="#prod-limit" role="tab" aria-controls="prod-limit" aria-selected="false">
                            <i class="ti-sm ti ti-layout-grid me-1"></i> Product Limitation
                        </a>
                    </li>
                   <!-- <li class="nav-item" role="presentation">
                        <a class="nav-link" id="others-activity-tab" data-bs-toggle="tab" href="#others-activity" role="tab" aria-controls="others-activity" aria-selected="false">
                            <i class="ti-sm ti ti-alarm me-1"></i>Input Others Activity
                        </a>
                    </li> -->
                    <!-- <li class="nav-item" role="presentation">
                        <a class="nav-link" id="prodplan-activity-tab" data-bs-toggle="tab" href="#prodplan-activity" role="tab" aria-controls="prodplan-activity" aria-selected="false">
                            <i class="ti-sm ti ti-archive me-1"></i>Input Production Plan
                        </a>
                    </li> -->
                </ul>
                <!-- Tab content -->
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="row-data" role="tabpanel" aria-labelledby="row-data-tab">
                        <div class="d-flex justify-content-start align-items-center mb-4">
                            <div>
                                <label for="start_date" class="form-label">Start Date</label>
                                <!-- Start Date Filter -->
                                <div style="width: 180px; margin-right: 15px">
                                    <div class="position-relative d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Start Date">
                                        <input type="text" id="start_date" class="form-control" placeholder="Start Date">
                                        <span class="position-absolute me-3 end-0"><i class="fa fa-calendar"></i></span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="end_date" class="form-label">End Date</label>
                                <!-- End Date Filter -->
                                <div style="width: 180px; margin-right: 15px">
                                    <div class="position-relative d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="End Date">
                                        <input type="text" id="end_date" class="form-control" placeholder="End Date">
                                        <span class="position-absolute me-3 end-0"><i class="fa fa-calendar"></i></span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label for="series" class="form-label">Location</label>
                                <!-- Series Filter -->
                                <div style="width: 180px">
                                    <div class="position-relative d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Location">
                                        <select id="series" class="form-control form-control-solid">
                                            <option value="Molding 1">Molding 1</option>
                                            <option value="Molding 2">Molding 2</option>
                                            <option value="Vertikal">Vertikal</option>
                                        </select>
                                        <span class="position-absolute me-3 end-0"><i class="fa fa-caret-down"></i></span>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-left: 15px; margin-top: 27px;">
                                <button class="btn btn-secondary" id="btnRefreshMold">Refresh Machines</button>
                            </div>
                            <div style="margin-left: 50px; margin-top: 27px;">
                                <button id="export_excel" class="btn btn-icon btn-warning text-main fs-4">
                                    <i class="fa fa-file-excel" data-bs-toggle="tooltip" data-bs-title="Export to XLS"></i>
                                </button>
                            </div>
                            <div style="margin-left: 10px; margin-top: 40px;">
                                <h3>Machine : <span class="ml-2" id="text-machine"></span></h3>
                            </div>
                        </div>

                        <!-- Machine Names will be displayed here -->
                        <div id="machine-container" class="d-flex flex-wrap my-4"></div>
                        
                        <table id="grid-excel" >
                            <thead>
                                <tr style="font-size: 1px;">
                                        <th>HEADER ID</th>
                                        <th>DETAIL ID</th>
                                        <th>PRODUCTION DATE</th>
                                        <th>SHIFT</th>
                                        <th>MACHINE</th>
                                        <th>MOLD NAME</th>
                                        <th>DIES NO</th>
                                        <th>INSTRUCTION NO</th>
                                        <th>PRODUCT CODE</th>
                                        <th>PRODUCT NAME</th>
                                        <th>CAVITY</th>
                                        <th>CYCLE TIME</th>
                                        <th>SPM</th>
                                        <th>OEE CODE</th>
                                        <th>ACT CODE</th>
                                        <th>START</th>
                                        <th>FINISH</th>
                                        <th>TIME CALC (DETIK)</th>
                                        <th>PRODUCT QTY</th>
                                        <th>SCRAP QTY</th>
                                        <th>LOT START</th>
                                        <th>LOT END</th>
                                        <th>JUMLAH LOT</th>
                                        <th>EMPLOYEE NO</th>
                                        <th>EMPLOYEE NAME</th>
                                        <th>TROUBLE</th>
                                    </tr>
                                </thead>
                            </table>
                            
                        
                        <h5 class="mt-3 px-4 py-2 fw-bold" style="background-color: #BBF7D0; border-radius: 5px; display: inline-block">
                            Header Data
                        </h5>
                        <!-- DataTable to display machine Header -->
                        <div class="card-datatable table-responsive pt-0 mb-3">
                            <table class="datatables-basic table table-bordered" id="grid-header">
                                <thead class="table-light">
                                    <tr>
                                        <th>Action</th>
                                        <th>ID</th>
                                        <th>Production Date</th>
                                        <th>Machine Code</th>
                                        <th>Dies</th>
                                        <th>Dies Cav</th>
                                        <th>Inst. No</th>
                                        <th>Product Code</th>
                                        <th>Product Name</th>
                                        <th>CYCLE TIME</th>
                                        <th>Cavity</th>
                                        <th>SPM</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>

                        <div class="mt-3 d-flex w-100 gap-3 align-items-center">
                            <h5 class="px-4 py-2 fw-bold" style="background-color: #FEF08A; border-radius: 5px; display: inline-block">
                                Detail Data
                            </h5>
                            <!-- <span id="total_time_actual" class="ms-3" style="font-weight: bold">Total Time Actual: 0</span> -->
                            <h5 id="total_time_calc" class="ms-3" style="font-weight: bold">Total Time : 0</h5>
                        </div>
                        <!-- DataTable to display machine Detail -->
                        <div class="card-datatable table-responsive pt-0">
                            <table class="datatables-basic table table-bordered" id="grid-detail">
                                <thead class="table-light">
                                    <tr>
                                        <!-- <th>Action</th> -->
                                        <th>ID</th>
                                        <th>Shift</th>
                                        <th>Act Code</th>
                                        <th>Start</th>
                                        <th>Finish</th>
                                        <th>Time</th>
                                        <th>Employee</th>
                                        <th>Prod Qty</th>
                                        <th>Lot Start</th>
                                        <th>Lot End</th>
                                        <th>Remark</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="others-activity" role="tabpanel" aria-labelledby="others-activity-tab">
                        <div class="d-flex justify-content-left align-items-center mb-4">
                                <!-- Left Section: Production Date Filter -->
                            <div class="">
                                <label for="prod_date" class="form-label me-2">Production Date</label>
                                <div style="width: 180px; margin-right: 15px">
                                    <div class="position-relative d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Production Date">
                                        <input type="text" id="prod_date" class="form-control" placeholder="Production Date">
                                        <span class="position-absolute me-3 end-0"><i class="fa fa-calendar"></i></span>
                                    </div>
                                </div>
                            </div>
                            <!-- Right Section: Buttons -->
                            <div class="d-flex align-items-center mt-4">
                                <!-- Add Others Activity Button -->
                                <button type="button" class="btn btn-secondary create-new btn-success" data-bs-toggle="modal" data-bs-target="#add_others_activity_modal">
                                    <span><i class="ti ti-plus me-sm-1"></i> <span class="d-none d-sm-inline-block">Add Others Activity</span></span>
                                </button>

                                <!-- Refresh Button -->
                                <button type="button" class="btn btn-secondary refresh-btn ms-2">
                                    <span><i class="ti ti-refresh me-sm-1"></i> <span class="d-none d-sm-inline-block">Refresh</span></span>
                                </button>
                            </div>
                        </div>
                        <div class="card-datatable table-responsive pt-0">
                            <table class="datatables-basic table table-bordered" id="grid-others">
                                <thead class="table-light">
                                    <tr>
                                        <th>Action</th>
                                        <th>ID</th>
                                        <th>Machine Code</th>
                                        <th>Activity</th>
                                        <th>Start</th>
                                        <th>Finish</th>
                                        <th>Remark</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="prod-limit" role="tabpanel" aria-labelledby="prod-limit-tab">

                        <div class="d-flex align-items-center mb-4">
                            <div class="d-flex align-items-center me-3 position-relative" style="width: 120px;">
                                <label for="monthPeriod" class="form-label me-2">Month</label>
                                <select id="monthPeriod" class="form-control form-select-dark w-100">
                                    <option value="01">Jan</option>
                                    <option value="02">Feb</option>
                                    <option value="03">Mar</option>
                                    <option value="04">Apr</option>
                                    <option value="05">May</option>
                                    <option value="06">Jun</option>
                                    <option value="07">Jul</option>
                                    <option value="08">Aug</option>
                                    <option value="09">Sep</option>
                                    <option value="10">Oct</option>
                                    <option value="11">Nov</option>
                                    <option value="12">Dec</option>
                                </select>
                                <span class="position-absolute end-0 me-3" style="top: 50%; transform: translateY(-50%);"><i class="fa fa-caret-down"></i></span>
                            </div>
                            <div class="d-flex align-items-center me-3 position-relative" style="width: 150px;">
                                <label for="yearPeriod" class="form-label me-2">Year</label>
                                <select id="yearPeriod" class="form-control form-select-dark w-100">
                                    <!-- Tahun akan diisi oleh JavaScript -->
                                </select>
                                <span class="position-absolute end-0 me-3" style="top: 50%; transform: translateY(-50%);"><i class="fa fa-caret-down"></i></span>
                            </div>
                            <div>
                                <button class="btn btn-secondary" id="btnRefreshLimit" style="margin-right: 15px;">Refresh</button>
                            </div>
                            <div>
                                <div>
                                    <button type="button" class="btn create-new btn-success" id="btnAddLimit">
                                        <span><i class="ti ti-plus me-sm-1"></i> <span class="d-none d-sm-inline-block">Add Limitation</span></span>
                                    </button>
                                </div>
                            </div>
                        </div>                        


                        <div class="card-datatable table-responsive pt-0">
                            <table class="datatables-basic table table-bordered" id="tbl_prod_limit">
                                <thead class="table-light">
                                    <tr>
                                        <th>Action</th>
                                        <th>ID</th>
                                        <th>Machine Code</th>
                                        <th>Dies No</th>
                                        <th>Mold Name</th>
                                        <th>Partcode</th>
                                        <th>Partname</th>
                                        <th>Qty(Pcs)</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    
                    
                    <div class="tab-pane fade" id="prodplan-activity" role="tabpanel" aria-labelledby="prodplan-activity-tab">
                        <div class="d-flex justify-content-left align-items-center mb-4">
                                
                            <div style="width: 180px; margin-right: 15px">
                                <label for="monthPeriodIpp" class="form-label me-2">Month</label>
                                <div class="position-relative d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Month">
                                    <select id="monthPeriodIpp" class="form-control form-select-dark">
                                        <option value="01">Jan</option>
                                        <option value="02">Feb</option>
                                        <option value="03">Mar</option>
                                        <option value="04">Apr</option>
                                        <option value="05">May</option>
                                        <option value="06">Jun</option>
                                        <option value="07">Jul</option>
                                        <option value="08">Aug</option>
                                        <option value="09">Sep</option>
                                        <option value="10">Oct</option>
                                        <option value="11">Nov</option>
                                        <option value="12">Dec</option>
                                    </select>
                                    <span class="position-absolute me-3 end-0"><i class="fa fa-caret-down"></i></span>
                                </div>
                            </div>
                                
                            <div style="width: 180px; margin-right: 15px">
                                <label for="yearPeriodIpp" class="form-label me-2">Year</label>
                                <div class="position-relative d-flex align-items-center" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Year">
                                    <select id="yearPeriodIpp" class="form-control form-select-dark">
                                        <!-- JavaScript will populate this select element with the years -->
                                    </select>
                                    <span class="position-absolute me-3 end-0"><i class="fa fa-caret-down"></i></span>
                                </div>
                            </div>

                            <!-- Right Section: Buttons -->
                            <div class="d-flex align-items-center mt-4">
                                <!-- Add Others Activity Button -->
<!--                                <button type="button" class="btn btn-secondary create-new btn-success" data-bs-toggle="modal" data-bs-target="#add_others_activity_modal">
                                    <span><i class="ti ti-plus me-sm-1"></i> <span class="d-none d-sm-inline-block">Add Others Activity</span></span>
                                </button>-->

                                <!-- Refresh Button -->
                                <button type="button" class="btn btn-secondary ms-2" id="btnRefProdPlan">
                                    <span><i class="ti ti-refresh me-sm-1"></i> <span class="d-none d-sm-inline-block">Refresh</span></span>
                                </button>
                                <button type="button" class="btn btn-primary ms-2" id="btnGenProdPlan">
                                    <span><i class="ti ti-refresh me-sm-1"></i> <span class="d-none d-sm-inline-block">Generate</span></span>
                                </button>
                            </div>
                        </div>
                        <div class="card-datatable table-responsive pt-0">
                            <table class="datatables-basic table table-bordered" id="grid-prodplan">
                                <thead class="table-light">
                                    <tr>
                                        <th>Month</th>
                                        <th>Year</th>
                                        <th>Machine</th>
                                        <th>Plan Qty</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        <!--/ Navbar pills -->
    </div>
</div>

<!-- Modal for add others activity -->
<div class="modal fade" id="add_others_activity_modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-simple modal-dialog-centered modal-lg">
        <div class="modal-content p-3 p-md-5">
            <div class="modal-body">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="text-center mb-4">
                    <h3 class="mb-2">Add Others Activity</h3>
                </div>
                <form method="POST" enctype="multipart/form-data" id="add_others_activity" class="row g-3">
                    <div class="col-12 col-md-12">
                        <label for="tbzo_actcode" class="form-label">Activity <span style="color: red">*</span></label>
                        <select id="tbzo_actcode" class="selectpicker w-100" data-style="btn-default" data-live-search="true">
                            <option value="">Select Activity</option>
                            <?php foreach ($activity_data as $activity) { ?>
                                <option value="<?= htmlspecialchars($activity->mba_actcode) ?>"><?= htmlspecialchars($activity->mba_actcode) ?> | <?= htmlspecialchars($activity->mba_actname) ?></option>
                            <?php } ?>
                        </select>
                    </div>
                    <div class="col-12 col-md-12">
                        <label for="tbzo_start" class="form-label">Start Date <span style="color: red">*</span></label>
                        <input type="text" name="tbzo_start" id="tbzo_start" class="form-control" placeholder="Select Start Date (YYYY-MM-DD HH:mm)">
                    </div>
                    <div class="col-12 col-md-12">
                        <label for="tbzo_finish" class="form-label">Finish Date <span style="color: red">*</span></label>
                        <input type="text" name="tbzo_finish" id="tbzo_finish" class="form-control" placeholder="Select Finish Date (YYYY-MM-DD HH:mm)">
                    </div>
                    <div class="col-12 col-md-12">
                        <label for="machines" class="form-label">Machines <span style="color: red">*</span></label>
                        <select id="machines" name="machines" class="form-control">
                            <option value="">Select Machines</option>
                            <option value="all">All</option>
                            <option value="select">Select Machines</option>
                        </select>
                    </div>

                    <!-- Machine Code Select2 (hidden by default) -->
                    <div class="col-12 col-md-12 mt-3" id="machine-code-container" style="display: none">
                        <label for="machine_code" class="form-label">Machine Code </label>
                        <select id="machine_code" class="selectpicker w-100" data-style="btn-default" data-live-search="true" multiple>
                            <option value="">Select Machine Code</option>
                            <?php foreach ($machine_data as $machine) { ?>
                                <option value="<?= htmlspecialchars($machine->mchname) ?>"><?= htmlspecialchars($machine->mchname) ?></option>
                            <?php } ?>
                        </select>
                    </div>
                    <div class="col-12 col-md-12">
                        <label for="tbzo_remark" class="form-label">Remark</label>
                        <textarea name="tbzo_remark" id="tbzo_remark" class="form-control" rows="3" placeholder="Enter remark"></textarea>
                    </div>
                    <div class="col-12 mt-5 text-center">
                        <button type="submit" class="btn btn-success me-sm-3 me-1">
                            <span class="indicator-label">Save</span>
                            <span class="loading" style="display: none">Please wait...
                                <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                            </span>
                        </button>
                        <button type="reset" class="btn btn-label-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<form id="f_excel" action="<?= base_url("OEEDataMold/export_excel") ?>" method="post" class="d-none">
    <input type="hidden" name="start_date_excel" id="start_date_excel">
    <input type="hidden" name="end_date_excel" id="end_date_excel">
    <input type="hidden" name="series_excel" id="series_excel">
    <input type="hidden" name="mch_excel" id="mch_excel">
</form>

<!-- Modal Add/Edit -->
<div class="modal fade" id="modalLimit" tabindex="-1" aria-labelledby="modalLimitLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLimitLabel">Add Limitation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formLimit">
                    <div class="d-flex align-items-center mb-5">
                        <div class="d-flex align-items-center me-3">
                            <label for="monthModal" class="form-label" style="margin-right: 20px;">Month</label>
                            <input type="text" id="monthModal" class="form-control" style="width: 120px;" readonly>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <label for="yearModal" class="form-label" style="margin-right: 20px;">Year</label>
                            <input type="text" id="yearModal" class="form-control" style="width: 120px;" readonly>
                        </div>
                    </div>  

                    <div class="d-flex align-items-center mb-3">
                        <div class="d-flex align-items-center me-3">
                            <label for="partbom_partcode" class="form-label me-2">Part Code / Name</label>
                            <input type="text" id="partbom_partcode" class="form-control" placeholder="Part Code" style="width: 120px;" readonly>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <input type="text" id="partbom_partname" class="form-control" placeholder="Part Name" style="width: 370px;" readonly>
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary" id="btnPartCode">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <div style="width: 233px">
                            <div class="position-relative d-flex align-items-center" data-bs-toggle="tooltip">
                                <label for="filterVal" class="form-label" style="margin-right: 63px;">Machine</label>
                                <select name="filterVal" id="filterVal" class="form-control form-select">
                                    <?php foreach ($machine_data as $machine) { ?>
                                        <option value="<?= htmlspecialchars($machine->mchname) ?>"><?= htmlspecialchars($machine->mchname) ?></option>
                                    <?php } ?>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <div class="d-flex align-items-center me-3">
                            <label for="dcavityindentity" class="form-label" style="margin-right: 66px;">Dies No</label>
                            <input type="text" id="dcavityindentity" class="form-control" placeholder="Dies No" style="width: 120px;" readonly>
                        </div>
                        <div class="d-flex align-items-center me-3">
                            <input type="text" id="dname" class="form-control" placeholder="Mold Name" style="width: 370px;" readonly>
                            <input type="hidden" id="dcode" class="form-control" placeholder="Dies Cav">
                            <input type="text" id="id_limit" class="form-control" hidden>
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary" id="btnDies">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <div class="d-flex align-items-center me-3">
                            <label for="qty" class="form-label" style="margin-right: 90px;">Qty</label>
                            <input type="text" id="qty" class="form-control" placeholder="Qty" style="width: 120px; margin-right: 20px;">
                            <label for="qtypcs" class="form-label">PCS</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="btnSaveLimit">
                    <span><span class="d-none d-sm-inline-block">Save</span></span>
                </button>
                <button type="reset" class="btn btn-label-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal for edit detail -->
<div class="modal fade" id="edit_detail_modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-simple modal-dialog-centered modal-lg">
        <div class="modal-content p-3 p-md-5">
            <div class="modal-body">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="text-center mb-4">
                    <h3 class="mb-2">Edit Machine Detail</h3>
                </div>
                <form method="POST" enctype="multipart/form-data" id="edit_detail" class="row g-3">
                    <input type="hidden" name="tmlh_id" id="tmlh_id">
                    <input type="hidden" name="tmld_id" id="tmld_id">
                    <div class="col-6 col-md-6">
                        <label for="tmld_start" class="form-label">Start Date</label>
                        <input type="text" name="tmld_start" id="tmld_start" class="form-control" placeholder="Select Start Date (YYYY-MM-DD HH:mm)">
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="tmld_finish" class="form-label">Finish Date</label>
                        <input type="text" name="tmld_finish" id="tmld_finish" class="form-control" placeholder="Select Finish Date (YYYY-MM-DD HH:mm)">
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="tmld_prodresult_qty" class="form-label">Actual Counter</label>
                        <input type="number" min="0" name="tmld_prodresult_qty" id="tmld_prodresult_qty" class="form-control" placeholder="Enter quantity">
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="tmld_scrapmaint_qty" class="form-label">Scrap Maintenance</label>
                        <input type="number" min="0" name="tmld_scrapmaint_qty" id="tmld_scrapmaint_qty" class="form-control" placeholder="Enter quantity">
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="tmld_rework_qty" class="form-label">Rework Qty</label>
                        <input type="number" min="0" name="tmld_rework_qty" id="tmld_rework_qty" class="form-control" placeholder="Enter quantity">
                    </div>
                    <div class="col-12">
                        <label for="tmld_remark" class="form-label">Remark</label>
                        <textarea name="tmld_remark" id="tmld_remark" class="form-control" rows="3" placeholder="Enter remark"></textarea>
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="tmld_isrolling" class="form-label">Is Rolling?</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="tmld_isrolling_checkbox">
                            <label class="form-check-label" for="tmld_isrolling_checkbox">Yes</label>
                        </div>
                        <input type="hidden" name="tmld_isrolling" id="tmld_isrolling" value="0">
                    </div>
                    <div class="col-12 mt-5 text-center">
                        <button type="submit" class="btn btn-success me-sm-3 me-1">
                            <span class="indicator-label">Save</span>
                            <span class="loading" style="display: none">Please wait...
                                <span class="spinner-border spinner-border-sm align-middle ms-2"></span>
                            </span>
                        </button>
                        <button type="reset" class="btn btn-label-secondary" data-bs-dismiss="modal" aria-label="Close">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for partcode -->
<div class="modal fade" id="partModal" tabindex="-1" aria-labelledby="partModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="partModalLabel">Select Part</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table id="tblPartList" class="table table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th>Part Code</th>
                            <th>Part Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTable content will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal for dies -->
<div class="modal fade" id="diesModal" tabindex="-1" aria-labelledby="diesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="diesModalLabel">Select Part</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table id="tblDiesList" class="table table-striped" style="width:100%">
                    <thead>
                        <tr>
                            <th>Dies</th>
                            <th>Mold Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- DataTable content will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        let base_url = '<?= base_url() ?>';

        $('#btnPartCode').click(function() {
            $('#partModal').modal('show');
        });

        $('#export_excel').on('click', function() {
            getExcelData();
        });
        
        $('#series').on('change', function() {
            $("#text-machine").text('');
        });

        var tablePartList = $("#tblPartList").DataTable({
            processing: true,
            serverSide: false,
            ajax: {
                url: base_url + "OEEDataMold/get_partcode",
                type: "GET",
                dataType: "json",
                error: function(xhr, status, error) {
                    console.error("Error loading data:", error);
                },
                beforeSend: function() {
                    $('#tblPartList tbody').html(`
                        <tr>
                            <td colspan="2" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    `);
                },
                dataSrc: function(json) {
                    // console.log("API Response: ", json);
                    return json;  // Pastikan ini berupa array
                }
            },
            columns: [
                { data: 'partbom_partcode' },
                { data: 'partbom_partname' }
            ]
        });

        // Event saat memilih baris di tabel
        $('#tblPartList tbody').on('click', 'tr', function() {
            var rowData = tablePartList.row(this).data();

            if (rowData) {
                // Set nilai input dari data yang dipilih
                $('#partbom_partcode').val(rowData.partbom_partcode);
                $('#partbom_partname').val(rowData.partbom_partname);

                // Tutup modal
                $('#partModal').modal('hide');
            }
        });

        $('#btnDies').click(function() {
            $('#diesModal').modal('show');
        });

        var tableDies = $("#tblDiesList").DataTable({
            processing: true,
            serverSide: false,
            ajax: {
                url: base_url + "OEEDataMold/get_dies",
                type: "GET",
                dataType: "json",
                error: function(xhr, status, error) {
                    console.error("Error loading data:", error);
                },
                beforeSend: function() {
                    $('#tblDiesList tbody').html(`
                        <tr>
                            <td colspan="2" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    `);
                },
                dataSrc: function(json) {
                    // console.log("API Response: ", json);
                    return json;  // Pastikan ini berupa array
                }
            },
            columns: [
                { data: 'dcavityindentity' },
                { data: 'dname' }
            ]
        });

        // Event saat memilih baris di tabel
        $('#tblDiesList tbody').on('click', 'tr', function() {
            var rowData = tableDies.row(this).data();

            if (rowData) {
                // Set nilai input dari data yang dipilih
                $('#dcavityindentity').val(rowData.dcavityindentity);
                $('#dname').val(rowData.dname);
                $('#dcode').val(rowData.dcode);

                // Tutup modal
                $('#diesModal').modal('hide');
            }
        });

        // Saat modal dibuka, isi nilai month dan year di modal dari dropdown filter utama
        $('#modalLimit').on('show.bs.modal', function () {
            let selectedMonth = $('#monthPeriod').val(); // Ambil nilai bulan dari dropdown utama
            let selectedYear = $('#yearPeriod').val(); // Ambil nilai tahun dari dropdown utama

            // console.log(selectedMonth, selectedYear);
            let monthText = $('#monthPeriod option:selected').text(); // Ambil teks bulan
            let yearText = selectedYear; // Teks tahun sama dengan value

            $('#monthModal').val(monthText); // Set nilai month di modal
            $('#yearModal').val(yearText); // Set nilai year di modal
        });

        // $('#btnSaveLimit').on('click', function() {
        //     var formData = {
        //         month: $('#monthPeriod').val(),
        //         year: $('#yearPeriod').val(),
        //         partbom_partcode: $('#partbom_partcode').val(),
        //         partbom_partname: $('#partbom_partname').val(),
        //         mchname: $('#filterVal').val(),
        //         dcavityindentity: $('#dcavityindentity').val(),
        //         dname: $('#dname').val(),  
        //         dcode: $('#dcode').val(),  
        //         qty: $('#qty').val(),    
        //         id_limit: $('#id_limit').val()    
        //     };
        //     // console.log(formData);     

        //     // Validasi input tidak boleh kosong
        //     if (!formData.partbom_partcode || !formData.partbom_partname || !formData.mchname || !formData.dcavityindentity || !formData.dname || !formData.qty) {
        //         Swal.fire({
        //             icon: 'warning',
        //             title: 'Oops...',
        //             text: 'All fields are required!',
        //         });
        //         return;
        //     }
        //     $.ajax({
        //         type: "POST",
        //         url: base_url + "OEEDataMold/cek_data_limitation", 
        //         data: formData,
        //         success: function(response) {      
        //             // console.log(response);
                    
        //             if (response.exists) {
        //                 Swal.fire({
        //                     title: "Info!",
        //                     text: "Data Limitation sudah ada",
        //                     icon: "info",  // Huruf kecil untuk ikon
        //                     confirmButtonText: "OK"
        //                 });
        //                 return
        //             } else {
        //                 // Kirim data ke server dengan AJAX
        //                 $.ajax({
        //                     url: base_url + "OEEDataMold/add_limit",  // Pastikan URL benar
        //                     type: 'POST',
        //                     data: formData,
        //                     dataType: 'json',
        //                     success: function (response) {
        //                         if (response.success) {
        //                             Swal.fire({
        //                                 icon: 'success',
        //                                 title: 'Success!',
        //                                 text: response.message,
        //                                 showConfirmButton: false,
        //                                 timer: 2000
        //                             });
        
        //                             // Refresh DataTable jika diperlukan
        //                             $('#tbl_prod_limit').DataTable().ajax.reload();
        //                             $("#modalLimit").modal("hide");
        //                         } else {
        //                             Swal.fire({
        //                                 icon: 'error',
        //                                 title: 'Error!',
        //                                 text: response.message || 'Failed to save data.',
        //                             });
        //                         }
        //                     },
        //                     error: function (xhr, status, error) {
        //                         Swal.fire({
        //                             icon: 'error',
        //                             title: 'Error!',
        //                             text: 'Something went wrong. Please try again later.',
        //                         });
        //                         console.error('AJAX error:', xhr.responseText);
        //                     }
        //                 });

        //             }
        //         },
        //         error: function(errorData) {
        //             $('#wait_screen').hide();
        //             Swal.fire("Error!", "An error occurred while checking the data.", "error");
        //         }
        //     });

        // });

        // Inisialisasi select2
        // $('#filterVal').select2();
        $('#btnRefreshLimit').on('click', function() {
            var month = $('#monthPeriod').val();
            var year = $('#yearPeriod').val();
            
            // console.log("Selected Month:", month, "Selected Year:", year);

            if (!month || !year) {
                alert("Month and Year must be selected!");
                return;
            }
            loadProdLimit(month, year);
            
        });

        // Reset modal sebelum menampilkan dalam mode tambah
        function resetModal() {
            $("#modalLimitLabel").text("Add Limitation");
            $("#id_limit").val(""); // Kosongkan ID saat mode Add
            $("#partbom_partcode, #partbom_partname, #dcavityindentity, #dname, #dcode, #qty").val("");
            $("#btnSaveLimit").text("Save");
            $("#btnSaveLimit").attr("onclick", "saveLimit()"); // Set function save
        }

        // Event untuk membuka modal dalam mode tambah
        $("#btnAddLimit").on("click", function () {
            openModal("add"); // Konsisten gunakan openModal
        });

        // Fungsi untuk membuka modal dalam mode add/edit
        function openModal(mode, data = null) {
            let modalTitle = $("#modalLimitLabel");
            let btnSave = $("#btnSaveLimit");
            
            if (mode === "add") {
                modalTitle.text("Add Limitation");
                btnSave.text("Save");
                btnSave.off("click").on("click", saveLimit); // Atur event handler untuk Save
                $("#formLimit")[0].reset(); // Reset form
            } else if (mode === "edit") {
                modalTitle.text("Edit Limitation");
                btnSave.text("Update");
                btnSave.off("click").on("click", function () {
                    updateLimit(data.tml_id);
                });
                
                // Isi form dengan data yang akan diedit
                $("#monthModal").val(data.tml_month);
                $("#yearPeriod").val(data.tml_year);
                $("#partbom_partcode").val(data.tml_partcode);
                $("#partbom_partname").val(data.tml_partname);
                $("#filterVal").val(data.tml_mchcode);
                $("#dcavityindentity").val(data.tml_diesno);
                $("#dname").val(data.tml_dies_cavid);
                $("#dcode").val(data.tml_diescode);
                $("#qty").val(data.tml_qty);
                $("#id_limit").val(data.tml_id);
            }

            $("#modalLimit").modal("show");
        }

        function saveLimit() {
            
            var formData = {
                month: $('#monthPeriod').val(),
                year: $('#yearPeriod').val(),
                partbom_partcode: $('#partbom_partcode').val(),
                partbom_partname: $('#partbom_partname').val(),
                mchname: $('#filterVal').val(),
                dcavityindentity: $('#dcavityindentity').val(),
                dname: $('#dname').val(),
                dcode: $('#dcode').val(),
                qty: $('#qty').val(),
                id_limit: $('#id_limit').val()
            };

            // Validasi input
            if (!formData.partbom_partcode || !formData.partbom_partname || !formData.mchname || 
                !formData.dcavityindentity || !formData.dname || !formData.qty) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Oops...',
                    text: 'All fields are required!',
                });
                return;
            }

            // Periksa apakah data sudah ada sebelum menyimpan
            $.ajax({
                type: "POST",
                url: base_url + "OEEDataMold/cek_data_limitation",
                data: formData,
                dataType: 'json',
                success: function(response) {
                    if (response.exists) {
                        Swal.fire({
                            title: "Info!",
                            text: "Data Limitation sudah ada",
                            icon: "info",
                            confirmButtonText: "OK"
                        });
                    } else {
                        // Kirim data ke server untuk disimpan
                        $.ajax({
                            url: base_url + "OEEDataMold/add_limit",
                            type: 'POST',
                            data: formData,
                            dataType: 'json',
                            success: function (response) {
                                if (response.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success!',
                                        text: response.message,
                                        showConfirmButton: false,
                                        timer: 2000
                                    });

                                    // Refresh DataTable
                                    $('#tbl_prod_limit').DataTable().ajax.reload();
                                    $("#modalLimit").modal("hide");
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error!',
                                        text: response.message || 'Failed to save data.',
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error!',
                                    text: 'Something went wrong. Please try again later.',
                                });
                                console.error('AJAX error:', xhr.responseText);
                            }
                        });
                    }
                },
                error: function(xhr) {
                    Swal.fire("Error!", "An error occurred while checking the data.", "error");
                }
            });
        }

        function updateLimit(id) {

            var formData = {
                month: $('#monthPeriod').val(),
                year: $('#yearPeriod').val(),
                partbom_partcode: $('#partbom_partcode').val(),
                partbom_partname: $('#partbom_partname').val(),
                mchname: $('#filterVal').val(),
                dcavityindentity: $('#dcavityindentity').val(),
                dname: $('#dname').val(),
                dcode: $('#dcode').val(),
                qty: $('#qty').val(),
                id_limit: id // ID yang akan diupdate
            };

            // Validasi input
            if (!formData.partbom_partcode || !formData.partbom_partname || !formData.mchname || 
                !formData.dcavityindentity || !formData.dname || !formData.qty) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Oops...',
                    text: 'All fields are required!',
                });
                return;
            }
            $.ajax({
                type: "POST",
                url: base_url + "OEEDataMold/cek_data_limitation",
                data: formData,
                dataType: 'json',
                success: function(response) {
                    if (response.exists) {
                        Swal.fire({
                            title: "Info!",
                            text: "Data Limitation sudah ada",
                            icon: "info",
                            confirmButtonText: "OK"
                        });
                    } else {
                        // Kirim data untuk update
                        $.ajax({
                            url: base_url + "OEEDataMold/add_limit",
                            type: 'POST',
                            data: formData,
                            dataType: 'json',
                            success: function (response) {
                                if (response.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success!',
                                        text: response.message,
                                        showConfirmButton: false,
                                        timer: 2000
                                    });

                                    // Refresh DataTable
                                    $('#tbl_prod_limit').DataTable().ajax.reload();
                                    $("#modalLimit").modal("hide");
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error!',
                                        text: response.message || 'Failed to save data.',
                                    });
                                }
                            },
                            error: function (xhr, status, error) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error!',
                                    text: 'Something went wrong. Please try again later.',
                                });
                                console.error('AJAX error:', xhr.responseText);
                            }
                        });
                    }
                },
                error: function(xhr) {
                    Swal.fire("Error!", "An error occurred while checking the data.", "error");
                }
            });

            
        }

        // Event klik tombol edit
        $(document).on("click", ".btnEditLimit", function () {
            let tml_id = $(this).data("id");

            // Ambil data berdasarkan ID dengan AJAX
            $.ajax({
                url: base_url + "OEEDataMold/get_limit_detail",
                type: "post",
                data: { id: tml_id },
                dataType: "json",
                success: function (response) {
                    if (response.status) {
                        openModal("edit", response.data);
                    } else {
                        alert("Failed to get data");
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", error);
                }
            });
        });


        $(document).on("click", ".btnDeleteLimit", function() {
            var tml_id = $(this).data("id");
            // console.log(tml_id);
            
            updateStatusLimit(tml_id, 25); // Update status to 25 (Delete)
        });

        // Function to update status via AJAX
        function updateStatusLimit(tml_id, newStatus) {
            Swal.fire({
                title: "Are you sure?",
                text: "You will delete the data. Do you want to proceed?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, proceed!",
                cancelButtonText: "Cancel",
                allowOutsideClick: false,
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: "<?= base_url('OEEDataMold/update_data_limitation') ?>",
                        type: "POST",
                        data: {
                            tml_id,
                            new_status: newStatus
                        },
                        success: function(response) {
                            if (!response.success) {
                                Swal.fire("Error!", response.message, "error");
                            }
                            return response;
                        }
                    }).catch(() => Swal.fire("Error!", "An error occurred while updating status.", "error"));
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: "Status Updated",
                        text: result.value.message,
                        icon: "success",
                        showConfirmButton: false,
                        timer: 1000
                    });
                    $('#tbl_prod_limit').DataTable().ajax.reload();
                }
            });
        }

        $('#btnGenProdPlan').on('click', function() {
            var formData = {
                month: $('#monthPeriodIpp').val(),
                year: $('#yearPeriodIpp').val()
            }
            // console.log(formData);
            $.ajax({
                url: base_url + "OEEDataMold/generate_data",
                type: 'POST',
                data: formData,
                dataType: 'json',
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                success: function (response) {
                    // console.log(response);
                    
                    if (response.success) { 
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: response.message,
                            showConfirmButton: false,
                            timer: 2000
                        });

                        loadProdQty($('#monthPeriodIpp').val(), $('#yearPeriodIpp').val());
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'Error!',
                            text: response.message || 'Failed to save data.',
                        });
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: 'Something went wrong. Please try again later.',
                    });
                    console.error('AJAX error:', xhr.responseText);
                }
            });

        });

        $('#btnRefProdPlan').on('click', function() {
            loadProdQty($('#monthPeriodIpp').val(), $('#yearPeriodIpp').val());
        });

        function loadProdLimit(month, year){
            // Hancurkan DataTable lama agar bisa refresh data baru
            if ($.fn.DataTable.isDataTable("#tbl_prod_limit")) {
                $("#tbl_prod_limit").DataTable().destroy();
            }

            $("#tbl_prod_limit").DataTable({
                processing: true,
                serverSide: false,
                ajax: {
                    url: base_url + "OEEDataMold/get_data_limitation",
                    type: "POST",
                    data: { month: month, year: year },
                    dataType: "json",
                    beforeSend: function() {
                        $('#tbl_prod_limit tbody').html(`
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        `);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error loading data:", error);
                    },
                    dataSrc: function(json) {
                        if (!json.status) {
                            console.warn(json.message);
                            return [];
                        }
                        return json.data;
                    }
                },
                columns: [
                    {
                        data: null,
                        render: function(data, type, row) {
                            return `<div class="d-flex justify-content-center gap-2">
                                        <a href="javascript:;" class="btn btn-icon btn-outline-primary btnEditLimit" data-id="${row.tml_id}">
                                            <i class="fa fa-pen-to-square"></i>
                                        </a>
                                        <a href="javascript:;" class="btn btn-icon btn-outline-danger btnDeleteLimit" data-id="${row.tml_id}">
                                            <i class="fa fa-trash-can"></i>
                                        </a>
                                    </div>`;
                        },
                        className: "text-center"
                    },
                    { data: 'tml_id' },
                    { data: 'tml_mchcode' },
                    { data: 'tml_diesno' },
                    { data: 'tml_dies_cavid' },
                    { data: 'tml_partcode' },
                    { data: 'tml_partname' },
                    { data: 'tml_qty' }
                ]
            });
        }
        
        // Function to load machine header data
        function loadProdQty(month, year) {
            // console.log('load', month, year);
            $.ajax({
                url: '<?= base_url("OEEDataMold/get_prod_qty"); ?>',
                method: 'POST',
                data: {
                    monthPeriod: month,
                    yearPeriod: year
                },
                success: function(data) {
                    // Initialize or clear DataTable
                    if ($.fn.DataTable.isDataTable('#grid-prodplan')) {
                        $('#grid-prodplan').DataTable().clear().rows.add(data).draw();
                    } else {
                        $('#grid-prodplan').DataTable({
                            data: data,
                            columns: [{
                                    data: 'pp_month',
                                    className: "text-center"
                                },
                                {
                                    data: 'pp_year',
                                    className: "text-center"
                                },
                                {
                                    data: 'pp_machinename',
                                    className: "text-center"
                                },
                                {
                                    data: 'pp_planqty',
                                    className: "text-center",
                                    render: function(data, type, row) {
                                        // Format plan quantity with a thousand separator
                                        return data ? data.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : data;
                                    },
                                    // Enable inline editing for the quantity
                                    createdCell: function(td, cellData, rowData, row, col) {
                                        let originalValue = cellData; // Store the original value

                                        $(td).attr('contenteditable', true);

                                        // When a key is pressed inside the cell
                                        $(td).on('keydown', function(e) {
                                            // Allow: Backspace, Delete, Tab, Escape, Enter, Arrow keys, and numeric keys
                                            if (
                                                (e.key >= '0' && e.key <= '9') || // Allow numbers
                                                ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter', 'Escape'].includes(e.key)
                                            ) {
                                                if (e.key === 'Enter') {
                                                    e.preventDefault(); // Prevent default Enter behavior
                                                    var newQty = $(this).text().replace(/,/g, ''); // Remove commas
                                                    rowData.pp_planqty = newQty; // Update data in the row
                                                    $(this).text(newQty.replace(/\B(?=(\d{3})+(?!\d))/g, ",")); // Reformat with commas
                                                    // console.log(rowData);

                                                    // Send the updated quantity to the server
                                                    $.ajax({
                                                        url: '<?= base_url("OEEDataMold/update_prod_qty"); ?>',
                                                        method: 'POST',
                                                        data: {
                                                            monthPeriod: rowData.pp_month,
                                                            yearPeriod: rowData.pp_year,
                                                            machinename: rowData.pp_machinename,
                                                            planqty: newQty
                                                        },
                                                        success: function(response) {
                                                            // Show SweetAlert2 success notification
                                                            Swal.fire({
                                                                icon: response.success ? 'success' : 'error',
                                                                title: '',
                                                                text: response.error,
                                                                confirmButtonText: 'OK'
                                                            });
                                                        },
                                                        error: function(xhr, status, error) {
                                                            console.error('Error updating quantity:', error);
                                                        }
                                                    });
                                                }
                                            } else if (e.key === 'Escape') {
                                                // Revert to the original value if Escape is pressed
                                                $(this).text(originalValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                                            } else {
                                                e.preventDefault(); // Prevent any other non-numeric input
                                            }
                                        });

                                        // Prevent pasting non-numeric values
                                        $(td).on('paste', function(e) {
                                            e.preventDefault();
                                            const pastedData = e.originalEvent.clipboardData.getData('Text').replace(/[^0-9]/g, ''); // Allow only numeric values
                                            $(this).text(pastedData);
                                        });
                                    }
                                }
                            ],
                            "bLengthChange": false,
                            iDisplayLength: -1,
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching production plan:', error);
                }
            });
        }
        // console.log(loadProdQty($('#monthPeriodIpp').val(), $('#yearPeriodIpp').val()));


        // Trigger the function export XLS
        $('#btnRefreshMold').on('click', function() {
            loadMachineData();
        });

        // Listen for change on machines select dropdown
        $('#machines').on('change', function() {
            var selectedValue = $(this).val();
            var machineCodeLabel = $('label[for="machine_code"]');

            if (selectedValue === 'select') {
                // Show the machine code select2 dropdown
                
                $('#machine-code-container').show();
                $('#machine_code').prop('required', true); // Make machine code selection required

                // Add the red asterisk to the machine code label
                if (!machineCodeLabel.find('span').length) {
                    machineCodeLabel.append('<span style="color: red">*</span>');
                }
            } else {
                // Hide the machine code select2 dropdown and reset its value
                $('#machine-code-container').hide();
                $('#machine_code').val(null).trigger('change');
                $('#machine_code').prop('required', false); // Remove required attribute

                // Remove the red asterisk from the machine code label
                machineCodeLabel.find('span').remove();
            }
        });
        
        // Get the current month and year
        const currentMonth = new Date().getMonth() + 1; // Months are zero-based in JS
        const currentYear = new Date().getFullYear();

        // Set the current month in the start_month dropdown
        $('#monthPeriod').val(currentMonth.toString().padStart(2, '0'));
        $('#monthPeriodIpp').val(currentMonth.toString().padStart(2, '0'));

        // Populate end year options (current year to 10 years before)
        for (let year = currentYear; year >= currentYear - 10; year--) {
            $('#yearPeriod').append(`<option value="${year}">${year}</option>`);
            $('#yearPeriodIpp').append(`<option value="${year}">${year}</option>`);
        }
        loadProdQty($('#monthPeriodIpp').val(), $('#yearPeriodIpp').val());   
        loadProdLimit($('#monthPeriod').val(), $('#yearPeriod').val());


        
        var startDate = document.querySelector("#start_date");
        var endDate = document.querySelector("#end_date");
        var prodDate = document.querySelector("#prod_date");
        var tmld_start = document.querySelector("#tmld_start");
        var tmld_finish = document.querySelector("#tmld_finish");
        var start_edit = document.querySelector("#start_edit");
        var finish_edit = document.querySelector("#finish_edit");

        // Function to get the current date and time in the format "Y-m-d H:i"
        function getCurrentDate() {
            var now = new Date();
            var year = now.getFullYear();
            var month = ('0' + (now.getMonth() + 1)).slice(-2); // Adding leading zero if needed
            var day = ('0' + now.getDate()).slice(-2); // Adding leading zero if needed

            return `${year}-${month}-${day}`;
        }

        // Set default values for start_date and end_date
        var defaultDate = getCurrentDate();
        $('#start_date').val(defaultDate);
        $('#end_date').val(defaultDate);
        $('#prod_date').val(defaultDate);

        // Trigger the function when the page loads (initial request)
        loadMachineData();

        startDate.flatpickr({
            enableTime: false,
            dateFormat: "Y-m-d"
        });

        endDate.flatpickr({
            enableTime: false,
            dateFormat: "Y-m-d"
        });

        prodDate.flatpickr({
            enableTime: false,
            dateFormat: "Y-m-d"
        });

        tmld_start.flatpickr({
            dateFormat: "Y-m-d H:i", // Format for date
            enableTime: true, // Enable time picker
            time_24hr: true, // Use 24-hour format
            allowInput: true, // Allow manual input
            minuteIncrement: 1, // Increment minutes by 1
            onOpen: function(selectedDates, dateStr, instance) {
                instance.setDate(dateStr, true); // Set the date if manually entered
            }
        });

        tmld_finish.flatpickr({
            dateFormat: "Y-m-d H:i", // Format for date
            enableTime: true, // Enable time picker
            time_24hr: true, // Use 24-hour format
            allowInput: true, // Allow manual input
            minuteIncrement: 1, // Increment minutes by 1
            onOpen: function(selectedDates, dateStr, instance) {
                instance.setDate(dateStr, true); // Set the date if manually entered
            }
        });

        var tbzo_start = document.querySelector("#tbzo_start").flatpickr({
            dateFormat: "Y-m-d H:i", // Format for date
            enableTime: true, // Enable time picker
            time_24hr: true, // Use 24-hour format
            allowInput: true, // Allow manual input
            minuteIncrement: 1, // Increment minutes by 1
            defaultDate: new Date().setHours(7, 20), // Set default to today at 07:20
            onOpen: function(selectedDates, dateStr, instance) {
                instance.setDate(dateStr, true); // Set the date if manually entered
            }
        });

        var tbzo_finish = document.querySelector("#tbzo_finish").flatpickr({
            dateFormat: "Y-m-d H:i", // Format for date
            enableTime: true, // Enable time picker
            time_24hr: true, // Use 24-hour format
            allowInput: true, // Allow manual input
            minuteIncrement: 1, // Increment minutes by 1
            defaultDate: new Date().setHours(16, 50), // Set default to today at 07:20
            onOpen: function(selectedDates, dateStr, instance) {
                instance.setDate(dateStr, true); // Set the date if manually entered
            }
        });

        start_edit.flatpickr({
            dateFormat: "Y-m-d H:i", // Format for date
            enableTime: true, // Enable time picker
            time_24hr: true, // Use 24-hour format
            allowInput: true, // Allow manual input
            minuteIncrement: 1, // Increment minutes by 1
            onOpen: function(selectedDates, dateStr, instance) {
                instance.setDate(dateStr, true); // Set the date if manually entered
            }
        });

        finish_edit.flatpickr({
            dateFormat: "Y-m-d H:i", // Format for date
            enableTime: true, // Enable time picker
            time_24hr: true, // Use 24-hour format
            allowInput: true, // Allow manual input
            minuteIncrement: 1, // Increment minutes by 1
            onOpen: function(selectedDates, dateStr, instance) {
                instance.setDate(dateStr, true); // Set the date if manually entered
            }
        });
        
        // Function to load machine header data
        function getExcelData() {
            $.ajax({
                url: '<?= base_url("OEEDataMold/export_excel_fix"); ?>',
                method: 'POST',
                data: {
                    start_date_excel: $("#start_date").val(),
                    end_date_excel: $("#end_date").val(),
                    series_excel: $("#series").val(),
                    mch_excel: $("#text-machine").text()
                },
                success: function(data) {
                    if ($.fn.DataTable.isDataTable('#grid-excel')) {
                            $('#grid-excel').DataTable().clear().rows.add(data).draw();
                            // Update title dynamically
                            updateExportTitle();
                            $('#grid-excel').DataTable().button('.buttons-excel').trigger();
                        } else {
                            $('#grid-excel').DataTable({
                                data: data, 
                                columns: [
                                    {
                                        data: 'tmld_hdid',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_id',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_proddate',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_shift',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_mchcode',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_diesno',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_dies_cavid',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_instno',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_prodcode',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_prodname',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_cavity',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_cycle_time',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmlh_spm',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_oee_code',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_act_code',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_start',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_finish',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_ttime_calc',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_prodqty',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_scrapqty',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_lot_start',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_lot_end',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_jml_lot',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_emplno',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'tmld_emplname',
                                        className: "text-center"
                                    },
                                    {
                                        data: 'trouble',
                                        className: "text-center"
                                    }
                                ],
                                dom: 'Bfrtip',  // Enable Buttons
                                buttons: [
                                    {
                                        extend: 'excel',
                                        text: '<i class="ti ti-file-spreadsheet me-sm-1"></i> Export XLS',
                                        className: 'btn btn-warning custom-export-btn btn_exp_grid_excel',
                                        title: function() {
                                            return 'MOD_Data_Export_ ' + ($("#text-machine").text() === '' ? $("#series").val() : $("#text-machine").text()) + '_' + $('#start_date').val() + '_' + $('#end_date').val();
                                        },
                                        exportOptions: {
                                            columns: ':visible'
                                        }
                                    }
                                ],
                                autoWidth: false, // Disable auto width adjustment
                                lengthMenu: [5, 10, 25, 50, 100],
                                paging: false,    
                                searching: false,  
                                info: false,   
                            });
                            // Trigger Excel download after initializing the DataTable
                            updateExportTitle();
                            $('#grid-excel').DataTable().button('.buttons-excel').trigger();
                        }

                    
                    $('<style>')
                        .prop('type', 'text/css')
                        .html(`
                            .custom-export-btn {
                                display: none !important;
                            }
                        `)
                        .appendTo('head');
            
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching export data:', error);
                }
            });
        }
        
        function updateExportTitle() {
            const table = $('#grid-excel').DataTable();
            const newTitle = 'MOD_Data_Export_ ' + ($("#text-machine").text() === '' ? $("#series").val() : $("#text-machine").text()) + '_' + $('#start_date').val() + '_' + $('#end_date').val();
            table.button('.buttons-excel').text('<i class="ti ti-file-spreadsheet me-sm-1"></i> Export XLS');
            table.button('.buttons-excel').action(function(e, dt, button, config) {
                config.title = newTitle;
                $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
            });
        }

        // Function to load machine data
        function loadMachineData() {
            let start_date = $('#start_date').val();
            let end_date = $('#end_date').val();
            let series = $('#series').val();
            // console.log(start_date, end_date, series);

            // AJAX request to get machine data based on filters
            $.ajax({
                url: '<?= base_url("OEEDataMold/get_data"); ?>',
                method: 'POST',
                data: {
                    start_date: start_date,
                    end_date: end_date,
                    series: series
                },
                success: function(response) {
                    // console.log(response);
                    
                    // Clear the previous machine buttons
                    $('#machine-container').empty();

                    // Set a common width for all buttons
                    const buttonWidth = '100px'; // Define the desired width

                    // Create an "ALL" button to represent all machines
                    let allButton = $('<button>')
                        .text('ALL')
                        .addClass('btn btn-machine')
                        .css({
                            'background-color': '#312E81', // Black background
                            'color': 'white', // White text for contrast
                            'width': buttonWidth, // Set the common button width
                            'margin': '5px', // Add some margin for spacing between buttons
                            'border': '1px solid #18181B'
                        })
                        .on('click', function() {
                           loadMachineHeader('');
                        });
                    // console.log(allButton);
                    
                    $('#machine-container').append(allButton);

                    // Loop through each machine in the response and create a button for each
                    $.each(response, function(index, machine) {
                        let button = $('<button>')
                            .text(machine.mchname)
                            .addClass('btn btn-machine position-relative') // position-relative for the badge positioning
                            .css({
                                'background-color': machine.color,
                                'color': 'black',
                                'width': buttonWidth,
                                'margin': '5px',
                                'border': '1px solid #A1A1AA'
                            })
                            .attr('data-machine-code', machine.mchname)
                            .on('click', function() {
                                // Remove active class from all buttons and add to this one
                                $('#machine-container .btn-machine').removeClass('active');
                                $(this).addClass('active');
                                // console.log($(this).data('machine-code'));
                                if ($.fn.DataTable.isDataTable('#grid-detail')) {
                                    const dataTable = $('#grid-detail').DataTable();
                                    // Clear all rows from the DataTable and redraw
                                    dataTable.clear().draw();
                                    $('#total_time_calc').text(`Total Time: 0`);
                                }
                                // Load machine details when a machine button is clicked
                                loadMachineHeader($(this).data('machine-code'), start_date, end_date);

                            });

                        // If machine.isFinish is false, add a badge with the play icon
                        if (machine.isFinish == 0) {
                            let badge = $('<span>')
                                .addClass('position-absolute mt-n2 top-0 end-0 me-n1 badge bg-primary rounded-circle')
                                .css({
                                    'padding': '0.4rem', // Adjust size of the badge
                                    'font-size': '0.5rem' // Adjust font size if needed
                                })
                                .html('<i class="fas fa-play"></i>'); // Font Awesome play icon 

                            button.append(badge); // Append the badge to the button
                        }

                        $('#machine-container').append(button);
                    });

                    // Load machine details for "ALL" by default
                    loadMachineHeader('');
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching machine data:', error);
                }
            });
        }

        // Function to load machine header data
        function loadMachineHeader(machineCode, startDate, endDate) {
            $.ajax({
                url: '<?= base_url("OEEDataMold/get_machine_header"); ?>',
                method: 'POST',
                data: {
                    machine: machineCode,
                    start_date: startDate,
                    end_date: endDate
                },
                success: function(data) {
                    // Initialize or clear DataTable
                    if ($.fn.DataTable.isDataTable('#grid-header')) {
                        $('#grid-header').DataTable().clear().rows.add(data).draw();
                    } else {
                        $('#grid-header').DataTable({
                            data: data,
                            columns: [{
                                    data: 'tmlh_id',
                                    render: function(data, type, row, meta) {
                                        return '<button class="btn btn-icon btn-outline-primary btn-detail" data-id="' + data + '"><i class="fa fa-eye" data-bs-toggle="tooltip" data-bs-title="View Detail"></i></button>';
                                    },
                                    className: "text-center"
                                },
                                {
                                    data: 'tmlh_id',
                                    className: "text-center"
                                },
                                {
                                    data: 'tmlh_proddate',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_mchcode',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_dies_cavid',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_diesno',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_instno',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_prodcode',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_prodname',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_cycle_time',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_cavity',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                },
                                {
                                    data: 'tmlh_spm',
                                    render: function(data, type, row, meta) {
                                        return '<strong>' + data + '</strong>'; // Bold the production date
                                    }
                                }
                            ],
                            lengthMenu: [5, 10, 25, 50, 100],
                        });
                    }
                    if(machineCode == '') {
                            $('#text-machine').text('ALL');
                    } else {
                            $('#text-machine').text(machineCode);
                    }
                    // Attach click event listener to the action buttons
                    $('#grid-header').on('click', '.btn-detail', function() {
                        var id = $(this).data('id');
                        
                        loadMachineDetail(id); // Call the function to load the machine detail
                        // Remove the yellow background from all rows first
                        $('#grid-header tbody tr').removeClass('highlighted-row');

                        // Get the row for the clicked button
                        var row = $(this).closest('tr');

                        // Add yellow background color to the clicked row
                        row.addClass('highlighted-row');
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching machine header data:', error);
                }
            });
        }

        // Function to load machine detail data
        function loadMachineDetail(id) {
            
            $.ajax({
                url: '<?= base_url("OEEDataMold/get_machine_detail"); ?>',
                method: 'POST',
                data: {
                    header_id: id
                },
                success: function(data) {  
                    // console.log(data);
                                      
                    // Initialize or clear DataTable
                    if ($.fn.DataTable.isDataTable('#grid-detail')) {
                        $('#grid-detail').DataTable().clear().rows.add(data.details).draw();
                    } else {
                        $('#grid-detail').DataTable({
                            data: data.details,
                            columns: [
                                // {
                                //     data: null,
                                //     render: function(data, type, row) {
                                //         // Helper function to format date without seconds
                                //         function formatDateWithoutSeconds(dateStr) {
                                //             if (dateStr) {
                                //                 var date = new Date(dateStr);
                                //                 var year = date.getFullYear();
                                //                 var month = ('0' + (date.getMonth() + 1)).slice(-2);
                                //                 var day = ('0' + date.getDate()).slice(-2);
                                //                 var hours = ('0' + date.getHours()).slice(-2);
                                //                 var minutes = ('0' + date.getMinutes()).slice(-2);
                                //                 return `${year}-${month}-${day} ${hours}:${minutes}`;
                                //             }
                                //             return '';
                                //         }

                                //         // Format start and finish dates without seconds
                                //         var formattedStart = formatDateWithoutSeconds(row.tmld_start);
                                //         var formattedFinish = formatDateWithoutSeconds(row.tmld_finish);

                                //         return `<div class="d-flex gap-2">
                                //                     <a href="javascript:;" class="btn btn-icon btn-outline-secondary edit-button" data-header-id="${id}" data-id="${row.tmld_id}" 
                                //                         data-start="${formattedStart}" data-finish="${formattedFinish}" data-prodresult-qty="${row.tmld_prodresult_qty}" 
                                //                             data-scrapmaint-qty="${row.tmld_scrapmaint_qty}" data-rework-qty="${row.tmld_rework_qty}" data-remark="${row.tmld_remark}" 
                                //                             data-trouble="${row.tmld_trouble}" data-rolling="${row.tmld_isrolling}"><i class="fa fa-pen-to-square"></i></a>
                                //                     <a href="javascript:;" class="btn btn-icon btn-outline-danger btnDelete" data-id="${row.tmld_id}"><i class="fa fa-trash-can"></i></a>
                                //                 </div>`;
                                //     },
                                //     className: "text-center"
                                // },
                                {
                                    data: 'tmld_id',
                                    className: "text-center"
                                },
                                {
                                    data: 'tmld_shift'
                                },
                                {
                                    data: 'tmld_act_code'
                                },
                                {
                                    data: 'tmld_start',
                                    render: function(data, type, row) {
                                        if (data) {
                                            var date = new Date(data);
                                            var year = date.getFullYear();
                                            var month = ('0' + (date.getMonth() + 1)).slice(-2);
                                            var day = ('0' + date.getDate()).slice(-2);
                                            var hours = ('0' + date.getHours()).slice(-2);
                                            var minutes = ('0' + date.getMinutes()).slice(-2);
                                            return `${year}-${month}-${day} ${hours}:${minutes}`;
                                        }
                                        return data;
                                    }
                                },
                                {
                                    data: 'tmld_finish',
                                    render: function(data, type, row) {
                                        if (data) {
                                            var date = new Date(data);
                                            var year = date.getFullYear();
                                            var month = ('0' + (date.getMonth() + 1)).slice(-2);
                                            var day = ('0' + date.getDate()).slice(-2);
                                            var hours = ('0' + date.getHours()).slice(-2);
                                            var minutes = ('0' + date.getMinutes()).slice(-2);
                                            return `${year}-${month}-${day} ${hours}:${minutes}`;
                                        }
                                        return data;
                                    }
                                },
                                {
                                    data: 'tmld_ttime_calc'
                                },
                                {
                                    data: 'tmld_emplname'
                                },
                                {
                                    data: 'tmld_prodqty'
                                },
                                {
                                    data: 'tmld_lot_start'
                                },
                                {
                                    data: 'tmld_lot_end'
                                },
                                {
                                    data: 'tmld_remark'
                                }
                            ],
                            lengthMenu: [5, 10, 25, 50, 100],
                        });

                        // Attach click event for edit buttons
                        $('#grid-detail').on('click', '.edit-button', function() {
                            // Extract data attributes
                            const headerId = $(this).data('header-id');
                            const id = $(this).data('id');
                            const start = $(this).data('start');
                            const finish = $(this).data('finish');
                            const prodresultQty = $(this).data('prodresult-qty');
                            const scrapmaintQty = $(this).data('scrapmaint-qty');
                            const reworkQty = $(this).data('rework-qty');
                            const remark = $(this).data('remark');
                            const trouble = $(this).data('trouble');
                            const isrolling = $(this).data('rolling');

                            // Call openEditModal with the extracted data
                            openEditModal(headerId, id, start, finish, prodresultQty, scrapmaintQty, reworkQty, remark, trouble, isrolling);
                        });
                    }

                    // Display total time values
                    // $('#total_time_actual').text(`Total Time Actual: ${data.total_time_actual}`);
                    $('#total_time_calc').text(`Total Time: ${data.total_time_calc}`);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching machine detail data:', error);
                }
            });
        }
        
        document.getElementById('tmld_isrolling_checkbox').addEventListener('change', function() {
            document.getElementById('tmld_isrolling').value = this.checked ? '1' : '0';
        });

        function openEditModal(headerId, id, start, finish, prodresultQty, scrapmaintQty, reworkQty, remark, trouble, isrolling) {
            // Populate modal fields directly from data-attributes passed
            $('#tmlh_id').val(headerId);
            $('#tmld_id').val(id);
            $('#tmld_start').val(start);
            $('#tmld_finish').val(finish);
            $('#tmld_prodresult_qty').val(prodresultQty);
            $('#tmld_scrapmaint_qty').val(scrapmaintQty);
            $('#tmld_rework_qty').val(reworkQty);
            $('#tmld_remark').val(remark);
            $('#tmld_trouble').val(trouble);
            $("#tmld_trouble").selectpicker("destroy").selectpicker();
            $('#tmld_isrolling').val(isrolling);
            $('#tmld_isrolling_checkbox').prop('checked', isrolling == 1);

            // Open modal after populating all fields
            $('#edit_detail_modal').modal('show');
        }

        $("#edit_detail").submit(function(event) {
            event.preventDefault(); // Prevent default form submission

            showLoading();

            const tmlh_id = $("#tmlh_id").val();

            const data = {
                tmlh_id: tmlh_id,
                tmld_id: $("#tmld_id").val(),
                tmld_start: $("#tmld_start").val(),
                tmld_finish: $("#tmld_finish").val(),
                tmld_prodresult_qty: $("#tmld_prodresult_qty").val(),
                tmld_scrapmaint_qty: $("#tmld_scrapmaint_qty").val(),
                tmld_rework_qty: $("#tmld_rework_qty").val(),
                tmld_remark: $("#tmld_remark").val(),
                tmld_trouble: $("#tmld_trouble").val(),
                tmld_isrolling: $("#tmld_isrolling").val()
            };

            // AJAX to save the updated row
            $.ajax({
                method: "POST",
                url: "<?= base_url("OEEDataMold/update_detail") ?>",
                data: data,
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            title: "Data has been saved",
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1000
                        });
                        document.activeElement.blur();
                        $("#edit_detail_modal").modal("hide");
                        // Clear the form data
                        $("#edit_detail")[0].reset();
                        loadMachineDetail(tmlh_id);
                    } else {
                        Swal.fire("Error!", response.error, "error");
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire("Error!", "An error occurred while submitting the data.", "error");
                },
                complete: function() {
                    hideLoading();
                }
            });
        });

        // Handle Delete button click
        $(document).on("click", ".btnDelete", function() {
            var tmld_id = $(this).data("id");
            updateStatus(tmld_id, 25); // Update status to 25 (Delete)
        });

        // Handle Delete button click
        $(document).on("click", ".btnDeleteOthers", function() {
            var tbzo_id = $(this).data("id");
            updateStatusOthers(tbzo_id, 25); // Update status to 25 (Delete)
        });

        // Function to update status via AJAX
        function updateStatus(tmld_id, newStatus) {
            Swal.fire({
                title: "Are you sure?",
                text: "You will delete the data. Do you want to proceed?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, proceed!",
                cancelButtonText: "Cancel",
                allowOutsideClick: false,
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: "<?= base_url('OEEDataMold/update_status_data') ?>",
                        type: "POST",
                        data: {
                            tmld_id,
                            new_status: newStatus
                        }
                    }).then((response) => {
                        if (!response.success) {
                            throw new Error(response.message); // Throw error to reject the Promise
                        }
                        return response; // Return response for use in the `then`
                    }).catch(() => {
                        Swal.fire("Error!", "An error occurred while updating status.", "error");
                        throw new Error("AJAX error"); // Throw error to reject the Promise
                    });
                }
            }).then((result) => {
                // Check if the result is confirmed
                if (result.isConfirmed) {
                    Swal.fire({
                        title: "Status Updated",
                        text: "Status updated successfully", // Update message here
                        icon: "success",
                        showConfirmButton: false,
                        timer: 1000
                    });
                    loadMachineDetail(tmld_id); // Use tmld_id instead of tmlh_id
                }
            }).catch((error) => {
                console.error(error); // Log error to console
            });
        }

        // Function to update status via AJAX
        function updateStatusOthers(tbzo_id, newStatus) {
            Swal.fire({
                title: "Are you sure?",
                text: "You will delete the data. Do you want to proceed?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, proceed!",
                cancelButtonText: "Cancel",
                allowOutsideClick: false,
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return $.ajax({
                        url: "<?= base_url('OEEDataMold/update_status_others') ?>",
                        type: "POST",
                        data: {
                            tbzo_id,
                            new_status: newStatus
                        },
                        success: function(response) {
                            if (!response.success) {
                                Swal.fire("Error!", response.message, "error");
                            }
                            return response;
                        }
                    }).catch(() => Swal.fire("Error!", "An error occurred while updating status.", "error"));
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: "Status Updated",
                        text: result.value.message,
                        icon: "success",
                        showConfirmButton: false,
                        timer: 1000
                    });
                    table.ajax.reload();
                }
            });
        }

        // Initialize DataTable
        var table = $("#grid-others").DataTable({
            "processing": true,
            "serverSide": false,
            "ajax": {
                "url": "<?= base_url('OEEDataMold/get_data_others') ?>",
                "type": "POST",
                "data": function(d) {
                    d.proddate = $('#prod_date').val(); // Send the production date with the AJAX request
                },
                "dataSrc": function(json) {
                    return json;
                }
            },
            "columns": [{
                    data: null,
                    render: function(data, type, row) {
                        return `<div class="d-flex justify-content-center gap-2">
                                    <a href="javascript:;" class="btn btn-icon btn-outline-info btnEdit" data-id="${row.tbzo_id}" data-mchcode="${row.tbzo_mchcode}" data-actcode="${row.tbzo_actcode}" data-start="${row.tbzo_start}" data-finish="${row.tbzo_finish}" data-remark="${row.tbzo_remark}" title="Edit"><i class="fa fa-pen-to-square"></i></a>
                                    <a href="javascript:;" class="btn btn-icon btn-outline-danger btnDeleteOthers" data-id="${row.tbzo_id}" title="Delete"><i class="fa fa-trash-can"></i></a>
                                </div>`;
                    },
                    className: "text-center"
                },
                {
                    data: "tbzo_id"
                },
                {
                    data: "tbzo_mchcode"
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        return `${row.tbzo_actcode} | ${row.mba_actname}`;
                    }
                },
                {
                    data: "tbzo_start"
                },
                {
                    data: "tbzo_finish"
                },
                {
                    data: "tbzo_remark"
                }
            ]
        });      

        // Refresh button click event
        $('.refresh-btn').on('click', function() {
            // $('#prod_date').val(''); // Reset filter
            table.ajax.reload(); // Reload data without filter

            // Reset the default values for tbzo_start and tbzo_finish
            tbzo_start.setDate(new Date().setHours(7, 20), true);
            tbzo_finish.setDate(new Date().setHours(16, 50), true);
        });
    });
</script>

<?= $this->endSection() ?>